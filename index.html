<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliudGestor GCA | Enterprise ERP</title>
    
    <link rel="stylesheet" href="styles.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 3000" id="toast-area"></div>

    <div id="login-screen">
        <div class="login-box text-center fade-in">
            <div class="mb-4">
                <div class="bg-primary text-white rounded-3 d-inline-flex align-items-center justify-content-center p-3 mb-3 shadow">
                    <i class="fas fa-cubes fa-2x"></i>
                </div>
                <h3 class="fw-bold text-dark">EliudGestor GCA</h3>
                <p class="text-muted">ERP Industrial Enterprise</p>
            </div>
            <form id="login-form">
                <div class="form-floating mb-3 text-start">
                    <input type="text" class="form-control" id="u-name" required value="admin">
                    <label>Usuário Corporativo</label>
                </div>
                <div class="form-floating mb-4 text-start">
                    <input type="password" class="form-control" id="u-pass" required value="1234">
                    <label>Senha de Acesso</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-lg" id="btn-login">
                    <i class="fas fa-sign-in-alt me-2"></i> ACESSAR SISTEMA
                </button>
            </form>
            <div class="mt-4 text-muted small border-top pt-3">Demo: admin / 1234</div>
        </div>
    </div>

    <nav id="sidebar">
        <div class="p-4 border-bottom border-secondary d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-3">
                <i class="fas fa-layer-group fa-lg text-info"></i>
                <div><h6 class="m-0 fw-bold text-white">EliudGestor</h6><small style="opacity:0.6;">GCA TEXTIL</small></div>
            </div>
            <button class="btn btn-sm btn-outline-secondary d-lg-none border-0 text-white" onclick="toggleSidebar()">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>

        <div class="py-3 flex-grow-1 overflow-auto">
            <small class="text-uppercase text-muted fw-bold px-4 mb-2 d-block" style="font-size: 0.7rem;">Módulos</small>
            <a class="nav-link active" onclick="loadView('dashboard')"><i class="fas fa-chart-pie me-3"></i> Dashboard</a>
            <a class="nav-link" onclick="loadView('entrada')"><i class="fas fa-dolly me-3"></i> Entrada (NFe)</a>
            <a class="nav-link" onclick="loadView('estoque')"><i class="fas fa-boxes me-3"></i> Estoque</a>
            <div class="my-2 border-top border-secondary opacity-25"></div>
            <a class="nav-link" onclick="loadView('producao')"><i class="fas fa-industry me-3"></i> Produção</a>
            <a class="nav-link" onclick="loadView('acabado')"><i class="fas fa-clipboard-check me-3"></i> Acabados</a>
            <div class="my-2 border-top border-secondary opacity-25"></div>
            <a class="nav-link" onclick="loadView('saida')"><i class="fas fa-shipping-fast me-3"></i> Expedição</a>
        </div>

        <div class="p-3 bg-black bg-opacity-25">
            <button class="btn btn-outline-secondary w-100 text-light btn-sm" onclick="logout()"><i class="fas fa-power-off me-2"></i> Encerrar Sessão</button>
        </div>
    </nav>

    <div class="main-wrapper" id="app-content" style="filter: blur(5px);">
        
        <header class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center sticky-top shadow-sm">
            <div class="d-flex align-items-center gap-3">
                <button class="btn btn-light d-lg-none text-primary" onclick="toggleSidebar()"><i class="fas fa-bars fa-lg"></i></button>
                <h5 class="m-0 fw-bold text-secondary" id="page-title">Dashboard Executivo</h5>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-md-block line-height-sm">
                    <div class="fw-bold small text-dark">Administrador</div>
                    <small class="text-muted" style="font-size: 0.75rem;">Gerente</small>
                </div>
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center fw-bold shadow-sm" style="width: 40px; height: 40px;">AD</div>
            </div>
        </header>

        <div class="p-4">

            <div id="view-dashboard" class="view-section fade-in">
                <div class="row g-4 mb-4">
                    <div class="col-md-4"><div class="kpi-box bg-primary"><small class="text-uppercase opacity-75 fw-bold">Matéria Prima</small><h2 class="display-5 fw-bold mb-0" id="kpi-raw">0</h2><i class="fas fa-cubes position-absolute end-0 bottom-0 p-3 opacity-25 fa-3x"></i></div></div>
                    <div class="col-md-4"><div class="kpi-box bg-success"><small class="text-uppercase opacity-75 fw-bold">Acabados</small><h2 class="display-5 fw-bold mb-0" id="kpi-finished">0</h2><i class="fas fa-check-circle position-absolute end-0 bottom-0 p-3 opacity-25 fa-3x"></i></div></div>
                    <div class="col-md-4"><div class="kpi-box" style="background: #6366f1;"><small class="text-uppercase opacity-75 fw-bold">Peso Estoque</small><h2 class="display-5 fw-bold mb-0" id="kpi-weight">0 kg</h2><i class="fas fa-weight-hanging position-absolute end-0 bottom-0 p-3 opacity-25 fa-3x"></i></div></div>
                </div>
                <div class="erp-card h-100"><h5 class="text-primary mb-4">Produção Semanal</h5><div style="height: 300px;"><canvas id="mainChart"></canvas></div></div>
            </div>

            <div id="view-entrada" class="view-section fade-in" style="display: none;">
                <div class="erp-card border-primary border-start border-0 border-top-0 border-end-0 border-bottom-0" style="border-left-width: 5px !important;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-1 fw-bold"><i class="fas fa-file-invoice me-2 text-primary"></i>Entrada de NFe (Lote Único)</h5>
                        <button class="btn btn-success" onclick="triggerXML()"><i class="fas fa-cloud-upload-alt me-2"></i> Importar XML</button>
                        <input type="file" id="xml-input" hidden accept=".xml" onchange="processXML(this)">
                    </div>

                    <div class="bg-light p-4 rounded-3 border mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-5">
                                <label class="small fw-bold text-uppercase text-secondary mb-1">Número do Lote (NF)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white"><i class="fas fa-barcode"></i></span>
                                    <input type="text" id="in-batch" class="form-control fw-bold text-uppercase" placeholder="EX: LOTE-2024-001">
                                    <button class="btn btn-primary" onclick="openScanner('in-batch')"><i class="fas fa-camera"></i></button>
                                </div>
                            </div>
                            <div class="col-md-7 text-end"><button class="btn btn-outline-primary" onclick="openManualModal()"><i class="fas fa-plus me-2"></i> Manual</button></div>
                        </div>
                    </div>

                    <div class="table-responsive border rounded-3 mb-4">
                        <table class="table table-erp table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th class="text-center">Qtd</th>
                                    <th class="text-center">Peso Total</th>
                                    <th class="text-center text-primary">Peso Unit.</th>
                                    <th class="text-center">Tipo</th>
                                    <th class="text-end">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="temp-entry-body"><tr><td colspan="6" class="text-center py-5 text-muted">A lista está vazia. Aguardando itens...</td></tr></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-end gap-3 pt-3 border-top">
                        <button class="btn btn-outline-danger px-4" onclick="clearEntry()">Cancelar</button>
                        <button class="btn btn-success px-4 fw-bold shadow-sm" onclick="commitEntry()"><i class="fas fa-save me-2"></i> PROCESSAR ENTRADA</button>
                    </div>
                </div>
            </div>

            <div id="view-producao" class="view-section fade-in" style="display: none;">
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="erp-card h-100 border-primary" style="border-left-width: 5px !important; border-top: 0; border-right: 0; border-bottom: 0;">
                            <h5 class="fw-bold mb-4"><i class="fas fa-cogs me-2"></i>1. Configuração</h5>
                            <div class="mb-4">
                                <label class="small fw-bold text-secondary mb-1">SELECIONAR LOTE MP</label>
                                <div class="input-group input-group-lg">
                                    <input type="text" id="prod-batch-search" class="form-control" placeholder="Buscar Lote...">
                                    <button class="btn btn-outline-secondary" onclick="openScanner('prod-batch-search')"><i class="fas fa-camera"></i></button>
                                    <button class="btn btn-primary px-4" onclick="loadBatchForProd()">CARREGAR</button>
                                </div>
                            </div>
                            <div id="prod-config-area" class="opacity-50" style="pointer-events: none; transition: 0.3s;">
                                <div class="mb-4">
                                    <label class="small fw-bold text-secondary mb-1">QUANTIDADE A PRODUZIR</label>
                                    <div class="input-group input-group-lg"><input type="number" id="prod-qty" class="form-control fw-bold text-primary" placeholder="0" oninput="calcProduction()"><span class="input-group-text">Unidades</span></div>
                                </div>
                                <div class="card bg-light border-0 p-3 rounded-3">
                                    <h6 class="small fw-bold text-primary mb-3">INSUMOS (Cola/Fio)</h6>
                                    <div class="d-flex gap-2 mb-2">
                                        <select id="common-item-select" class="form-select form-select-sm"></select>
                                        <input type="number" id="common-grams" class="form-control form-control-sm" placeholder="g/bag" style="width: 80px;">
                                        <button class="btn btn-sm btn-dark" onclick="addCommonItem()"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div id="common-list-display" class="small mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-7">
                        <div class="erp-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold mb-0"><i class="fas fa-balance-scale me-2"></i>2. Balanço</h5>
                                <span class="badge bg-secondary p-2" id="active-batch-badge">Nenhum Lote Ativo</span>
                            </div>

                            <div class="table-responsive border rounded-3 mb-4">
                                <table class="table table-erp table-sm mb-0">
                                    <thead><tr><th>Componente</th><th>Fator</th><th>Peso Est.</th><th>Status</th></tr></thead>
                                    <tbody id="prod-calc-body"><tr><td colspan="4" class="text-center py-5 text-muted">Aguardando configuração...</td></tr></tbody>
                                    <tfoot class="bg-light fw-bold"><tr><td colspan="3" class="text-end py-3">PESO TOTAL TEÓRICO:</td><td class="text-end py-3 text-primary fs-5" id="total-weight-calc">0.00 kg</td></tr></tfoot>
                                </table>
                            </div>

                            <div class="bg-warning bg-opacity-10 p-3 rounded border border-warning mb-3">
                                <label class="small fw-bold text-dark text-uppercase mb-1"><i class="fas fa-trash-alt me-1"></i> Resíduos (Opcional)</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" id="prod-waste" class="form-control fw-bold" placeholder="0.00">
                                    <span class="input-group-text">kg</span>
                                </div>
                                <small class="text-muted" style="font-size: 0.75rem;">Se não houver sobras para pesar, deixe em 0.</small>
                            </div>

                            <button class="btn btn-secondary w-100 py-3 fw-bold shadow-sm" id="btn-finish-prod" disabled onclick="finishProduction()">
                                <i class="fas fa-check-double me-2"></i> CONFIRMAR E BAIXAR ESTOQUE
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-estoque" class="view-section fade-in" style="display: none;">
                <div class="erp-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0 fw-bold">Estoque de Matéria Prima</h5>
                        <button class="btn btn-outline-success btn-sm" onclick="exportExcel()"><i class="fas fa-file-excel me-2"></i> Excel</button>
                    </div>
                    <div class="table-responsive border rounded-3">
                        <table class="table table-erp table-striped table-hover mb-0">
                            <thead><tr><th>Lote</th><th>Item</th><th>Qtd Disp.</th><th>Peso Tot.</th><th>Peso Unit.</th></tr></thead>
                            <tbody id="stock-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-acabado" class="view-section fade-in" style="display: none;">
                <div class="erp-card">
                    <h5 class="mb-4 fw-bold">Histórico de Produção</h5>
                    <div class="table-responsive border rounded-3">
                        <table class="table table-erp table-hover mb-0">
                            <thead><tr><th>Data</th><th>Lote</th><th>Qtd</th><th>Peso Útil</th><th>Status</th></tr></thead>
                            <tbody id="finished-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-saida" class="view-section fade-in" style="display: none;">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="erp-card border-danger border-start border-0 border-top-0 border-end-0 border-bottom-0" style="border-left-width: 5px !important;">
                            <h5 class="text-danger mb-4 fw-bold"><i class="fas fa-truck-loading me-2"></i>Expedição / Despacho</h5>
                            
                            <div class="mb-3">
                                <label class="small fw-bold text-uppercase mb-1">Selecione Lote Acabado</label>
                                <select id="dispatch-select" class="form-select form-select-lg"></select>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6"><label class="small fw-bold text-uppercase mb-1">Quantidade</label><input type="number" id="dispatch-qty" class="form-control form-control-lg" placeholder="0"></div>
                                <div class="col-md-6"><label class="small fw-bold text-uppercase mb-1">Cliente</label><input type="text" id="dispatch-client" class="form-control form-control-lg" placeholder="Ex: Cliente XYZ"></div>
                            </div>
                            <button class="btn btn-danger w-100 mt-5 py-3 fw-bold shadow-sm" onclick="processDispatch()"><i class="fas fa-paper-plane me-2"></i> CONFIRMAR SAÍDA</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="manualItemModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">Novo Item Manual</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="manual-form">
                        <div class="mb-3"><label class="small fw-bold">Descrição</label><input type="text" id="m-desc" class="form-control" required></div>
                        <div class="row g-2 mb-3"><div class="col"><label class="small fw-bold">Qtd</label><input type="number" id="m-qty" class="form-control" required></div><div class="col"><label class="small fw-bold">Peso Total (kg)</label><input type="number" step="0.01" id="m-weight" class="form-control"></div></div>
                        <div class="mb-3"><label class="small fw-bold">Tipo</label><select id="m-type" class="form-select"><option value="KIT">KIT (Componente)</option><option value="COMUM">COMUM (Insumo)</option></select></div>
                        <div class="alert alert-info small py-2"><i class="fas fa-info-circle"></i> Se não for pesar (ex: Etiquetas), deixe o Peso em 0 ou vazio.</div>
                        <button type="submit" class="btn btn-primary w-100 mt-2">Confirmar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scannerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-0">
                <div class="modal-header border-secondary"><h5 class="modal-title fs-6"><i class="fas fa-camera me-2"></i>Leitura de Código</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body p-0 position-relative"><div id="reader" style="width: 100%;"></div></div>
            </div>
        </div>
    </div>

    <script src="main.js?v=2"></script>
</body>
</html>