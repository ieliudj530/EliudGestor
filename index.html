<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliudGestorGCA - Sistema de Gest√£o</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --sidebar-width: 260px;
        }

        body { display: flex; min-height: 100vh; overflow-x: hidden; }

        /* MENU LATERAL (SIDEBAR) */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: #212529;
            color: #fff;
            transition: all 0.3s;
            display: flex; flex-direction: column;
        }
        
        #sidebar.active { margin-left: calc(var(--sidebar-width) * -1); }
        
        #sidebar .list-group-item {
            background: transparent;
            color: #ccc;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        #sidebar .list-group-item:hover { background: #343a40; color: #fff; padding-left: 25px; }
        #sidebar .list-group-item.active { background: #0d6efd; color: #fff; }
        #sidebar .list-group-item i { width: 25px; }

        /* CONTE√öDO PRINCIPAL */
        #content { width: 100%; padding: 20px; transition: all 0.3s; background-color: #f8f9fa; }
        [data-bs-theme="dark"] #content { background-color: #121212; }

        /* ANIMA√á√ÉO DE TROCA DE TELA */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* √ÅREA DE IMPRESS√ÉO (ETIQUETAS) */
        #printable-area { display: none; }
        
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area {
                position: absolute; left: 0; top: 0; width: 100%;
                display: flex; flex-direction: column; align-items: center; justify-content: center;
            }
            .etiqueta { 
                border: 2px solid #000; padding: 20px; margin: 20px; text-align: center; 
                width: 300px; page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="sidebar-header p-4 border-bottom border-secondary">
            <h3>üè≠ EliudGestor<span class="text-primary">GCA</span></h3>
            <small class="text-muted">Sistema Integrado de Gest√£o</small>
        </div>
        
        <ul class="list-group list-group-flush mt-3 flex-grow-1">
            <li class="list-group-item active" onclick="showView('dashboard')">
                <i class="fas fa-chart-pie"></i> Painel Geral
            </li>
            <li class="list-group-item" onclick="showView('entrada')">
                <i class="fas fa-truck-loading"></i> Entrada (MP)
            </li>
            <li class="list-group-item" onclick="showView('producao')">
                <i class="fas fa-industry"></i> Produ√ß√£o
            </li>
            <li class="list-group-item" onclick="showView('acabado')">
                <i class="fas fa-boxes"></i> Estoque Acabado
            </li>
            <li class="list-group-item" onclick="showView('saida')">
                <i class="fas fa-shipping-fast"></i> Expedi√ß√£o / Sa√≠da
            </li>
        </ul>
        
        <div class="p-3">
            <button class="btn btn-outline-light w-100" onclick="toggleTheme()">
                <i class="fas fa-moon"></i> Modo Escuro
            </button>
        </div>
    </nav>

    <div id="content">
        
        <nav class="navbar navbar-light bg-white shadow-sm mb-4 rounded d-md-none p-2">
            <button type="button" id="sidebarCollapse" class="btn btn-primary">
                <i class="fas fa-bars"></i> Menu
            </button>
        </nav>

        <div id="view-dashboard" class="view-section active">
            <h2 class="mb-4">üìä Painel de Controle</h2>
            
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card text-white bg-primary h-100">
                        <div class="card-header">Mat√©ria Prima em Estoque</div>
                        <div class="card-body display-4 fw-bold" id="total-raw">0</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-white bg-success h-100">
                        <div class="card-header">Produtos Acabados Prontos</div>
                        <div class="card-body display-4 fw-bold" id="total-finished">0</div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header d-flex justify-content-between align-items-center bg-white">
                            <span class="fw-bold">Hist√≥rico Recente</span>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToExcel('history-table')">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                        </div>
                        <div class="card-body p-0 overflow-auto" style="max-height: 300px;">
                            <table class="table table-hover table-striped mb-0" id="history-table">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Produto</th>
                                        <th>Qtd</th>
                                    </tr>
                                </thead>
                                <tbody id="history-body" class="small"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-entrada" class="view-section">
            <h2 class="mb-4">üì• Entrada de Mercadoria</h2>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="card p-3 mb-3 border-primary shadow-sm">
                        <h5 class="text-primary"><i class="fas fa-file-code"></i> Importar XML (NFe)</h5>
                        <small class="text-muted d-block mb-2">Carregue o arquivo para preencher o estoque automaticamente.</small>
                        <div class="input-group">
                            <input type="file" id="xmlFile" class="form-control" accept=".xml">
                            <button class="btn btn-primary" onclick="processXML()">Carregar</button>
                        </div>
                    </div>

                    <div class="card p-3 shadow-sm">
                        <h5>üìù Entrada Manual</h5>
                        <form id="form-entrada">
                            <div class="mb-3">
                                <label class="form-label">C√≥digo de Barras</label>
                                <div class="input-group">
                                    <input type="text" id="barcode-input" class="form-control" placeholder="Escaneie ou digite..." required>
                                    <button class="btn btn-outline-secondary" type="button" onclick="startCamera('barcode-input')">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <label>Descri√ß√£o do Produto</label>
                                <input type="text" id="desc-input" class="form-control" required>
                            </div>
                            <div class="mb-2">
                                <label>Quantidade</label>
                                <input type="number" id="qty-input" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label>Fornecedor</label>
                                <input type="text" id="provider-input" class="form-control">
                            </div>
                            <button type="submit" class="btn btn-success w-100">Confirmar Entrada</button>
                        </form>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div class="card p-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Estoque de Mat√©ria Prima</h5>
                            <button class="btn btn-sm btn-outline-success" onclick="exportTableToExcel('raw-table')">
                                <i class="fas fa-download"></i> Baixar Relat√≥rio
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="raw-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>C√≥d. Barras</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Qtd.</th>
                                        <th>Lote Interno</th>
                                        <th>Fornecedor</th>
                                    </tr>
                                </thead>
                                <tbody id="raw-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-producao" class="view-section">
            <h2 class="mb-4">‚öôÔ∏è Linha de Produ√ß√£o</h2>
            
            <div class="card p-4 mb-4 border-warning shadow-sm">
                <h4 class="text-warning-emphasis">In√≠cio de Ordem de Produ√ß√£o</h4>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">Selecionar Mat√©ria Prima (Dispon√≠vel)</label>
                        <select id="raw-select" class="form-select"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantidade a Utilizar</label>
                        <input type="number" id="qty-prod" class="form-control" placeholder="0">
                    </div>
                    <div class="col-md-3">
                        <button onclick="startProduction()" class="btn btn-warning w-100 fw-bold">
                            <i class="fas fa-play"></i> Iniciar Lote
                        </button>
                    </div>
                </div>
            </div>

            <div class="card p-3 shadow-sm">
                <h4>Lotes em Processamento</h4>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Lote Prod.</th>
                                <th>Material Base</th>
                                <th>Qtd. Usada</th>
                                <th>Hora In√≠cio</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="production-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-acabado" class="view-section">
            <h2 class="mb-4">‚úÖ Estoque Acabado</h2>
            <div class="card p-3 shadow-sm">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aqui est√£o os produtos prontos para serem enviados ao cliente.
                </div>
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Lote Final</th>
                            <th>Produto</th>
                            <th>Estoque</th>
                            <th>Data Finaliza√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="finished-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-saida" class="view-section">
            <h2 class="mb-4">üöö Expedi√ß√£o e Sa√≠da</h2>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card p-4 shadow border-danger">
                        <h4 class="text-danger border-bottom pb-3 mb-3">
                            <i class="fas fa-sign-out-alt"></i> Registrar Sa√≠da Definitiva
                        </h4>
                        
                        <div class="mb-3">
                            <label class="form-label">Selecione o Lote (Produto Acabado)</label>
                            <select id="dispatch-select" class="form-select"></select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Quantidade de Sa√≠da</label>
                                <input type="number" id="qty-out" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cliente / Destino</label>
                                <input type="text" id="destination" class="form-control" placeholder="Ex: Mercado Central">
                            </div>
                        </div>

                        <button onclick="processExit()" class="btn btn-danger w-100 btn-lg mt-2">
                            CONFIRMAR BAIXA NO ESTOQUE
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scannerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Leitor de C√≥digo de Barras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                    <p class="text-muted mt-2">Aponte a c√¢mera para o c√≥digo</p>
                </div>
            </div>
        </div>
    </div>

    <div id="printable-area"></div>

    <script>
        // --- 1. BANCO DE DADOS (LOCALSTORAGE) ---
        const DB_KEYS = { RAW: 'estoque_mp', PROD: 'estoque_prod', FINISHED: 'estoque_acabado', HISTORY: 'historico_geral' };
        let html5QrCode;
        let chartInstance = null;

        const Storage = {
            get: (key) => JSON.parse(localStorage.getItem(key)) || [],
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            add: (key, item) => {
                const data = Storage.get(key);
                data.push(item);
                Storage.save(key, data);
            },
            log: (type, prod, qty, batch, details = '') => {
                const entry = { id: Date.now(), date: new Date().toLocaleString('pt-BR'), type, prod, qty, batch, details };
                Storage.add(DB_KEYS.HISTORY, entry);
            }
        };

        // --- 2. INICIALIZA√á√ÉO E NAVEGA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            showView('dashboard');
            setupMobileMenu();
        });

        function showView(viewId) {
            // Esconde todas as telas
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('#sidebar .list-group-item').forEach(el => el.classList.remove('active'));
            
            // Mostra a tela escolhida
            document.getElementById(`view-${viewId}`).classList.add('active');
            
            // Ativa o menu correspondente
            const menuMap = { 'dashboard':0, 'entrada':1, 'producao':2, 'acabado':3, 'saida':4 };
            if(menuMap[viewId] !== undefined) {
                document.querySelectorAll('#sidebar .list-group-item')[menuMap[viewId]].classList.add('active');
            }

            // Carrega dados espec√≠ficos da tela
            if(viewId === 'dashboard') initDashboard();
            if(viewId === 'entrada') renderTableRaw();
            if(viewId === 'producao') initProductionUI();
            if(viewId === 'acabado') renderFinishedTable();
            if(viewId === 'saida') initExitUI();
        }

        function toggleTheme() {
            const html = document.documentElement;
            html.setAttribute('data-bs-theme', html.getAttribute('data-bs-theme') === 'dark' ? 'light' : 'dark');
        }

        function setupMobileMenu() {
            document.getElementById('sidebarCollapse').addEventListener('click', () => {
                document.getElementById('sidebar').classList.toggle('active');
            });
        }

        // --- 3. L√ìGICA DO DASHBOARD ---
        function initDashboard() {
            const raw = Storage.get(DB_KEYS.RAW);
            const finished = Storage.get(DB_KEYS.FINISHED);
            
            document.getElementById('total-raw').innerText = raw.reduce((acc, i) => acc + parseInt(i.qty), 0);
            document.getElementById('total-finished').innerText = finished.reduce((acc, i) => acc + parseInt(i.qty), 0);
            
            // Gr√°fico
            const ctx = document.getElementById('stockChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mat√©ria Prima', 'Produto Acabado'],
                    datasets: [{
                        data: [raw.length, finished.length],
                        backgroundColor: ['#0d6efd', '#198754']
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // Tabela Hist√≥rico
            const history = Storage.get(DB_KEYS.HISTORY).reverse().slice(0, 10);
            document.getElementById('history-body').innerHTML = history.map(h => `
                <tr>
                    <td>${h.date}</td>
                    <td><span class="badge bg-${getBadgeColor(h.type)}">${h.type}</span></td>
                    <td>${h.prod}</td>
                    <td>${h.qty}</td>
                </tr>
            `).join('');
        }

        function getBadgeColor(type) {
            if(type === 'ENTRADA') return 'primary';
            if(type === 'SAIDA_FINAL') return 'danger';
            return 'warning';
        }

        // --- 4. ENTRADA E XML ---
        document.getElementById('form-entrada').addEventListener('submit', (e) => {
            e.preventDefault();
            const item = {
                id: Date.now(),
                barcode: document.getElementById('barcode-input').value,
                desc: document.getElementById('desc-input').value,
                qty: parseInt(document.getElementById('qty-input').value),
                provider: document.getElementById('provider-input').value,
                batch: 'MP-' + Date.now().toString().slice(-6),
                date: new Date().toLocaleString('pt-BR')
            };
            Storage.add(DB_KEYS.RAW, item);
            Storage.log('ENTRADA', item.desc, item.qty, item.batch);
            alert(`‚úÖ Entrada registrada com sucesso!\nLote Gerado: ${item.batch}`);
            e.target.reset();
            renderTableRaw();
        });

        // FUN√á√ÉO DE IMPORTA√á√ÉO XML
        function processXML() {
            const fileInput = document.getElementById('xmlFile');
            const file = fileInput.files[0];

            if (!file) {
                alert("‚ö†Ô∏è Por favor, selecione um arquivo XML primeiro.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const xmlContent = e.target.result;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");

                // --- ATEN√á√ÉO: AJUSTE AS TAGS ABAIXO CONFORME SEU XML ---
                // Procure no seu arquivo XML qual √© a palavra que envolve cada item. 
                // Exemplo comum em NFe brasileira: 'det' ou 'prod'
                let items = xmlDoc.getElementsByTagName("prod"); 
                if(items.length === 0) items = xmlDoc.getElementsByTagName("item"); // Tentativa alternativa

                let contador = 0;
                for (let i = 0; i < items.length; i++) {
                    const getVal = (tag) => {
                        const node = items[i].getElementsByTagName(tag)[0];
                        return node ? node.textContent : "";
                    };

                    // Mapeamento (Tente encontrar essas tags no seu XML)
                    // cProd = C√≥digo Produto | xProd = Descri√ß√£o | qCom = Quantidade
                    const codigo = getVal("cProd") || getVal("codigo") || "SEM-COD";
                    const descricao = getVal("xProd") || getVal("descricao") || "Produto Importado";
                    const quantidade = parseInt(getVal("qCom")) || parseInt(getVal("quantidade")) || 0;

                    if(quantidade > 0) {
                        const novoItem = {
                            id: Date.now() + i,
                            barcode: codigo,
                            desc: descricao,
                            qty: quantidade,
                            provider: "Importado via XML",
                            batch: 'XML-' + Date.now(),
                            date: new Date().toLocaleString('pt-BR')
                        };
                        Storage.add(DB_KEYS.RAW, novoItem);
                        contador++;
                    }
                }

                if(contador > 0) {
                    alert(`‚úÖ Sucesso! ${contador} produtos foram importados do XML.`);
                    renderTableRaw();
                } else {
                    alert("‚ö†Ô∏è Nenhum produto encontrado. Verifique se as tags do XML (cProd, xProd) est√£o corretas no c√≥digo.");
                }
            };
            reader.readAsText(file);
        }

        function renderTableRaw() {
            const data = Storage.get(DB_KEYS.RAW);
            document.getElementById('raw-body').innerHTML = data.map(i => `
                <tr><td>${i.barcode}</td><td>${i.desc}</td><td>${i.qty}</td><td>${i.batch}</td><td>${i.provider}</td></tr>
            `).join('');
        }

        // --- 5. PRODU√á√ÉO ---
        function initProductionUI() {
            const raw = Storage.get(DB_KEYS.RAW).filter(i => i.qty > 0);
            const select = document.getElementById('raw-select');
            
            if(raw.length === 0) {
                select.innerHTML = '<option>Sem mat√©ria prima dispon√≠vel</option>';
            } else {
                select.innerHTML = raw.map(i => `<option value="${i.id}">${i.desc} (Disp: ${i.qty}) - Lote: ${i.batch}</option>`).join('');
            }
            renderProductionTable();
        }

        function startProduction() {
            const rawId = document.getElementById('raw-select').value;
            const qty = parseInt(document.getElementById('qty-prod').value);
            
            if(!rawId || isNaN(qty) || qty <= 0) return alert('‚ùå Preencha uma quantidade v√°lida.');

            let rawData = Storage.get(DB_KEYS.RAW);
            let itemIdx = rawData.findIndex(i => i.id == rawId);
            
            if(itemIdx === -1 || rawData[itemIdx].qty < qty) return alert('‚ö†Ô∏è Estoque insuficiente para essa produ√ß√£o.');

            // Debitar MP
            rawData[itemIdx].qty -= qty;
            Storage.save(DB_KEYS.RAW, rawData);

            // Criar Ordem
            const prodItem = {
                id: Date.now(),
                rawDesc: rawData[itemIdx].desc,
                qtyUsed: qty,
                batch: 'PROD-' + Date.now().toString().slice(-6),
                status: 'PROCESSO',
                start: new Date().toLocaleString('pt-BR')
            };
            Storage.add(DB_KEYS.PROD, prodItem);
            Storage.log('PRODUCAO', prodItem.rawDesc, qty, prodItem.batch, 'In√≠cio Produ√ß√£o');
            
            // Gerar etiqueta do processo
            generateLabel(prodItem.batch, `EM PROCESSO: ${prodItem.rawDesc}`);
            alert(`‚úÖ Produ√ß√£o Iniciada!\nEtiqueta de lote ${prodItem.batch} gerada.`);
            initProductionUI();
        }

        function renderProductionTable() {
            const prods = Storage.get(DB_KEYS.PROD).filter(p => p.status === 'PROCESO');
            document.getElementById('production-body').innerHTML = prods.map(p => `
                <tr>
                    <td><strong>${p.batch}</strong></td>
                    <td>${p.rawDesc}</td>
                    <td>${p.qtyUsed}</td>
                    <td>${p.start}</td>
                    <td><button class="btn btn-success btn-sm" onclick="finishProduction(${p.id})"><i class="fas fa-check"></i> Finalizar</button></td>
                </tr>
            `).join('');
        }

        window.finishProduction = (id) => {
            const qtyFinal = prompt("Quantidade FINAL obtida (Produto Acabado):");
            const sobras = prompt("Quantidade de Sobras/Res√≠duos gerados:");
            
            if(qtyFinal && !isNaN(qtyFinal)) {
                let prods = Storage.get(DB_KEYS.PROD);
                let idx = prods.findIndex(p => p.id === id);
                if(idx !== -1) {
                    prods[idx].status = 'FINALIZADO';
                    Storage.save(DB_KEYS.PROD, prods);

                    const finishedItem = {
                        id: Date.now(),
                        desc: prods[idx].rawDesc + " (ACABADO)",
                        batch: prods[idx].batch,
                        qty: parseInt(qtyFinal),
                        sobras: sobras,
                        date: new Date().toLocaleString('pt-BR')
                    };
                    Storage.add(DB_KEYS.FINISHED, finishedItem);
                    Storage.log('ACABADO', finishedItem.desc, finishedItem.qty, finishedItem.batch, `Sobras: ${sobras}`);
                    
                    alert("‚úÖ Produ√ß√£o Finalizada! Produto movido para Estoque Acabado.");
                    initProductionUI();
                }
            }
        };

        // --- 6. ACABADO ---
        function renderFinishedTable() {
            const data = Storage.get(DB_KEYS.FINISHED).filter(i => i.qty > 0);
            document.getElementById('finished-body').innerHTML = data.map(i => `
                <tr>
                    <td>${i.batch}</td><td>${i.desc}</td><td>${i.qty}</td><td>${i.date}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="generateLabel('${i.batch}','${i.desc}')" title="Imprimir Etiqueta">
                            <i class="fas fa-print"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function generateLabel(code, text) {
            const area = document.getElementById('printable-area');
            area.innerHTML = `
                <div class="etiqueta">
                    <h3>${text}</h3>
                    <svg id="barcode-svg"></svg>
                    <p>Data: ${new Date().toLocaleDateString('pt-BR')}</p>
                    <p><strong>EliudGestorGCA</strong></p>
                </div>
            `;
            JsBarcode("#barcode-svg", code);
            window.print();
        }

        // --- 7. SA√çDA ---
        function initExitUI() {
            const data = Storage.get(DB_KEYS.FINISHED).filter(i => i.qty > 0);
            const select = document.getElementById('dispatch-select');
            
            if(data.length === 0) {
                select.innerHTML = "<option>Nenhum produto acabado em estoque</option>";
            } else {
                select.innerHTML = data.map(i => `<option value="${i.id}">${i.desc} (Lote: ${i.batch} | Qtd: ${i.qty})</option>`).join('');
            }
        }

        function processExit() {
            const id = document.getElementById('dispatch-select').value;
            const qty = parseInt(document.getElementById('qty-out').value);
            const dest = document.getElementById('destination').value;

            if(!id || isNaN(qty) || qty <= 0) return alert("‚ùå Verifique a quantidade.");

            let finished = Storage.get(DB_KEYS.FINISHED);
            let idx = finished.findIndex(i => i.id == id);

            if(idx !== -1 && finished[idx].qty >= qty) {
                finished[idx].qty -= qty;
                Storage.save(DB_KEYS.FINISHED, finished);
                Storage.log('SAIDA_FINAL', finished[idx].desc, qty, finished[idx].batch, `Destino: ${dest}`);
                alert("üöö Sa√≠da Registrada com Sucesso!\nEstoque atualizado.");
                initExitUI();
            } else {
                alert("‚õî Estoque insuficiente para esta sa√≠da.");
            }
        }

        // --- 8. UTILIT√ÅRIOS ---
        function exportTableToExcel(tableID) {
            const wb = XLSX.utils.table_to_book(document.getElementById(tableID));
            XLSX.writeFile(wb, 'Relatorio_EliudGestor.xlsx');
        }

        function startCamera(inputId) {
            const modalEl = document.getElementById('scannerModal');
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    document.getElementById(inputId).value = decodedText;
                    html5QrCode.stop();
                    modal.hide();
                    alert("C√≥digo detectado: " + decodedText);
                }
            ).catch(err => {
                console.error(err);
                alert("Erro ao abrir c√¢mera. Use HTTPS ou Localhost.");
                modal.hide();
            });

            modalEl.addEventListener('hidden.bs.modal', () => {
                if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
            });
        }
    </script>
</body>
</html>